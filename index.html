<script>
/* ========= 進階縮放系統 ========= */
let scale = 0.6;
let posX = 0, posY = 0;
let isDragging = false;
let lastMouseX, lastMouseY;

const viewport = document.getElementById('viewport');
const content = document.getElementById('zoomContent');

function updateTransform(){
  content.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
}

/* 以滑鼠或手指為中心縮放 */
function adjustZoom(delta, cx, cy){
  const rect = viewport.getBoundingClientRect();
  const x = cx ?? rect.width/2;
  const y = cy ?? rect.height/2;
  const prev = scale;

  scale = Math.min(Math.max(0.2, scale + delta), 2);

  posX = x - (x - posX) * (scale / prev);
  posY = y - (y - posY) * (scale / prev);

  updateTransform();
}

/* 滑鼠滾輪 */
viewport.addEventListener("wheel", e=>{
  e.preventDefault();
  adjustZoom(e.deltaY > 0 ? -0.1 : 0.1, e.offsetX, e.offsetY);
},{passive:false});

/* 拖曳 */
viewport.addEventListener("mousedown", e=>{
  if(e.target.closest(".seat")||e.target.closest(".pop-btn")) return;
  isDragging=true;
  content.style.transition="none";
  lastMouseX=e.clientX; lastMouseY=e.clientY;
});
window.addEventListener("mousemove", e=>{
  if(!isDragging) return;
  posX+=e.clientX-lastMouseX;
  posY+=e.clientY-lastMouseY;
  lastMouseX=e.clientX; lastMouseY=e.clientY;
  updateTransform();
});
window.addEventListener("mouseup", ()=>{
  isDragging=false;
  content.style.transition="transform .1s ease-out";
});

/* 觸控 */
let initialDist=0;
viewport.addEventListener("touchstart", e=>{
  if(e.touches.length===2){
    initialDist=Math.hypot(
      e.touches[0].pageX-e.touches[1].pageX,
      e.touches[0].pageY-e.touches[1].pageY
    );
  } else {
    isDragging=true;
    lastMouseX=e.touches[0].clientX;
    lastMouseY=e.touches[0].clientY;
  }
},{passive:false});

viewport.addEventListener("touchmove", e=>{
  if(e.touches.length===2){
    const d=Math.hypot(
      e.touches[0].pageX-e.touches[1].pageX,
      e.touches[0].pageY-e.touches[1].pageY
    );
    adjustZoom((d-initialDist)/300,
      (e.touches[0].clientX+e.touches[1].clientX)/2,
      (e.touches[0].clientY+e.touches[1].clientY)/2
    );
    initialDist=d;
  } else if(isDragging){
    posX+=e.touches[0].clientX-lastMouseX;
    posY+=e.touches[0].clientY-lastMouseY;
    lastMouseX=e.touches[0].clientX;
    lastMouseY=e.touches[0].clientY;
    updateTransform();
  }
},{passive:false});

viewport.addEventListener("touchend", ()=>{isDragging=false;});

/* ========= 原系統 ========= */

let seatMap = new Array(56).fill(null);
let rollCallStatus = new Array(56).fill("present");
let archives = {};
let isRollCallMode = false;
let activePopoverIdx = null;

/* 載入存檔 */
window.onload = ()=>{
  const saved = localStorage.getItem("e1c_zoom_v2");
  if(saved) archives = JSON.parse(saved);
  updateArchiveList();
  initGrid();
  updateTransform();
};

/* 存檔升級版 */
function createNewArchive(){
  const n = prompt("存檔名稱",`座位表_${new Date().toLocaleDateString()}`);
  if(!n) return;
  archives[n]={
    date:new Date().toISOString(),
    seatMap:[...seatMap],
    rollCallStatus:[...rollCallStatus]
  };
  localStorage.setItem("e1c_zoom_v2",JSON.stringify(archives));
  updateArchiveList();
}

/* 出席率 */
function getStudentStats(id){
  let total=0,present=0;
  for(const a of Object.values(archives)){
    a.seatMap.forEach((s,i)=>{
      if(s&&s.id===id){
        total++;
        if(a.rollCallStatus[i]==="present") present++;
      }
    });
  }
  return total?((present/total)*100).toFixed(1):"—";
}
</script>