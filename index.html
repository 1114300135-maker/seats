<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E1C åº§ä½é»åç³»çµ± (ç›´è¦ºè§¸æ§ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60;
            --danger: #e74c3c; --warning: #f1c40f; --bg: #f4f7f6;
        }

        body { 
            font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); 
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* ä½ˆå±€æ¶æ§‹ */
        .top-nav { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; }
        .main-container { flex: 1; display: flex; position: relative; overflow: hidden; }

        /* å´æ¬„ */
        .archive-panel { 
            width: 200px; background: #fff; border-right: 1px solid #ddd; 
            padding: 15px; overflow-y: auto; transition: transform 0.3s;
            position: absolute; left: 0; top: 0; bottom: 0; z-index: 999;
        }
        .archive-panel.collapsed { transform: translateX(-100%); }
        .archive-item { padding: 12px 8px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; }

        /* ç¸®æ”¾ç•«å¸ƒå€åŸŸ */
        .canvas-area { flex: 1; position: relative; background: #e9ecef; overflow: hidden; touch-action: none; }
        .zoom-layer { 
            position: absolute; transform-origin: 0 0; will-change: transform;
            padding: 150px; /* ç·©è¡å€ */
        }

        /* åº§ä½è¡¨æ¨£å¼ */
        .classroom-container { 
            background: #fff; padding: 50px 40px; border: 4px solid #333; 
            min-width: 950px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .classroom { display: grid; grid-template-columns: repeat(8, 115px); gap: 10px; }
        .seat { 
            border: 1px solid #ddd; height: 105px; background: #fff; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            position: relative; border-radius: 6px; box-sizing: border-box;
        }
        .seat.absent { background: #ffebee !important; border-color: var(--danger) !important; }
        .seat.late { background: #fff9e6 !important; border-color: var(--warning) !important; }

        /* UI å…ƒä»¶ */
        .toolbar { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 900; display: flex; gap: 10px; pointer-events: none; }
        .toolbar button { pointer-events: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        .zoom-controls { position: absolute; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 8px; z-index: 1000; }
        .ui-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .rollcall-popover {
            position: absolute; inset: 0; background: rgba(255,255,255,0.95);
            display: flex; flex-direction: column; padding: 5px; gap: 3px; z-index: 100;
        }
        .pop-btn { flex: 1; border: 1px solid #ddd; border-radius: 4px; font-weight: bold; font-size: 12px; }

        /* æ–‡å­—æ¨£å¼ */
        .std-id { font-size: 10px; color: #999; }
        .name { font-weight: bold; font-size: 16px; }
        .en-name { font-size: 11px; color: #7f8c8d; }
        .hidden { display: none !important; }
        
        .stats-badge { position: absolute; bottom: 25px; left: 25px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; z-index: 1000; }
    </style>
</head>
<body onclick="closeAllPopovers(event)">

    <div class="top-nav">
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="document.querySelector('.archive-panel').classList.toggle('collapsed')" class="ui-btn" style="width:35px; height:35px; background:#666;">â˜°</button>
            <span id="current-title" style="font-weight:bold;">ğŸ« E1C ç³»çµ±</span>
            <div id="mode-display" style="font-size:12px; padding:3px 10px; border-radius:10px; background:var(--primary); color:white;">æ’åº§æ¨¡å¼</div>
        </div>
        <div class="toolbar" style="position:static; transform:none;">
            <button class="ui-btn" style="width:auto; border-radius:20px; padding:0 15px; background:var(--success);" onclick="fillRandom()">ğŸ² éš¨æ©Ÿ</button>
            <button class="ui-btn" style="width:auto; border-radius:20px; padding:0 15px; background:var(--accent);" onclick="createNewArchive()">ğŸ’¾ å­˜æª”</button>
            <button class="ui-btn" style="width:auto; border-radius:20px; padding:0 15px; background:#6c5ce7;" onclick="toggleMode()">ğŸ”„ åˆ‡æ›æ¨¡å¼</button>
        </div>
    </div>

    <div class="main-container">
        <div class="archive-panel collapsed">
            <h4 style="margin:0 0 10px 0;">ğŸ“ æ­·å²å­˜æª”</h4>
            <div id="archive-list"></div>
        </div>

        <div class="canvas-area" id="canvasArea">
            <div class="zoom-layer" id="zoomLayer">
                <div class="classroom-container">
                    <div class="classroom" id="grid"></div>
                    <div style="margin-top:30px; border-top:3px solid #333; text-align:center; font-weight:bold; letter-spacing:15px; font-size:20px; padding-top:10px;">BLACKBOARD</div>
                </div>
            </div>
        </div>

        <div class="stats-badge id="stats-badge">
            æ‡‰åˆ°:<span id="stat-total">0</span> | ç¼ºå¸­:<span id="stat-absent" style="color:var(--danger)">0</span>
        </div>

        <div class="zoom-controls">
            <button class="ui-btn" onclick="zoomIn()">+</button>
            <button class="ui-btn" onclick="zoomOut()">-</button>
            <button class="ui-btn" style="font-size:10px;" onclick="resetView()">é‡ç½®</button>
        </div>
    </div>

    <script>
        // --- å­¸ç”Ÿæ•¸æ“šèˆ‡åˆå§‹åŒ– ---
        const allStudents = [
            {id:"1114300121", n:"é¾”æ˜±ç‘„", e:"Kelly"}, {id:"1114300122", n:"ä½™æ²›å®¹", e:"Melody"}, {id:"1114300123", n:"é™³æ¹˜ç”¯", e:"Ariel"}, {id:"1114300124", n:"æ—æ²æ¦†", e:"Amber"}, {id:"1114300125", n:"è•­ç¾½å½¤", e:"Amelia"}, {id:"1114300126", n:"æ—å¥•å¸†", e:"Ivan"}, {id:"1114300127", n:"é™³ä¹™ç‘„", e:"Sharon"}, {id:"1114300128", n:"ç‹æ¼†å¦¤", e:"Zoie"}, {id:"1114300129", n:"é™³éœå®œ", e:"Luna"}, {id:"1114300130", n:"é™³ç¥‰æ©", e:"Bianca"}, {id:"1114300131", n:"é™³åˆç‘„", e:"Christy"}, {id:"1114300132", n:"è³´å®¥ç’‡", e:"Alina"}, {id:"1114300133", n:"é™³çŸæ…ˆ", e:"Emily"}, {id:"1114300134", n:"æ±ŸèŠ¯èª", e:"Ina"}, {id:"1114300135", n:"é™³ä¸–è±ª", e:"Howard"}, {id:"1114300136", n:"æ›¾å®‰å²‘", e:"Ann"}, {id:"1114300137", n:"è³´ç‘¾å®‰", e:"Ashley"}, {id:"1114300138", n:"ç¾…å‡±çˆ¾", e:"Mikayeel"}, {id:"1114300139", n:"è¾›ä¿Šæ–‡", e:"Jun-wen"}, {id:"1114300140", n:"é»ƒé–æ™", e:"Amber"}, {id:"1114300141", n:"æ—ç´«é¨", e:"Nancy"}, {id:"1114300142", n:"å³éœˆç‘œ", e:"Yuri"}, {id:"1114300143", n:"è¨±å”¯èŠ¯", e:"Una"}, {id:"1114300144", n:"éŠèŠ¯èª", e:"Abby"}, {id:"1114300145", n:"éŠæ¢å¥é›…", e:"Luna"}, {id:"1114300146", n:"æå©•ç¦•", e:"Eve"}, {id:"1114300147", n:"ææ©å¦®", e:"Miu Miu"}, {id:"1114300148", n:"æ—é‡‘å§µ", e:"Linda"}, {id:"1114300149", n:"é™³å¯ç´œ", e:"Amber"}, {id:"1114300151", n:"å¼µé›…çŸ", e:"Judy"}, {id:"1114300152", n:"ç‰›æ˜±ç¿”", e:"Sean"}, {id:"1114300153", n:"é™³ä»¥å©•", e:"Emma"}, {id:"1114300154", n:"å¼µéˆºå©•", e:"Wendy"}, {id:"1114300155", n:"æœ±é›¯èŠ³", e:"Mia"}, {id:"1114300156", n:"é€£å­ç”¯", e:"Liliya"}, {id:"1114300157", n:"æ¥ŠèŠ·èŠ¹", e:"Alex"}, {id:"1114300158", n:"é™³ç¦æ¶µ", e:"Hannah"}, {id:"1114300159", n:"é™³å† å®‡", e:"Benson"}, {id:"1114300160", n:"é™³æ¼¢åº­", e:"Lina"}, {id:"1114300161", n:"å¼µä¹™èŠ¹", e:"Irene"}, {id:"1114300162", n:"ç‹å¦è»", e:"Grace"}, {id:"1114300163", n:"æ›²å­å¯¬", e:"Miller"}, {id:"1114300164", n:"ç‹ä»¥å€«", e:"Juan Jose"}, {id:"1114300165", n:"è¶™äºå«»", e:"Abby"}, {id:"1114300166", n:"æ—å®œæ¨º", e:"Novalie"}, {id:"1114300167", n:"æŸ¯å“ç‘€", e:"Pamela"}, {id:"1114300168", n:"å“å½¥å‡", e:"Cynthia"}, {id:"1114300169", n:"ææ˜“æ˜Œ", e:"Jason"}, {id:"1114300170", n:"å¼µå­ç‘œ", e:"Yvonne"}, {id:"1114300171", n:"å¼µæ¹˜ç¿Š", e:"Cecelia"}, {id:"1114300172", n:"å»–éšè–‡", e:"Nicole"}, {id:"1114300173", n:"é»ƒæ¯“éœ", e:"Lily"}, {id:"1114300174", n:"è”¡æ‚…ç³", e:"Lina"}, {id:"1114300175", n:"é™³å®¥å‰", e:"Iris"}, {id:"1114300501", n:"è³ˆä¼¯ç", e:"Haein"}, {id:"1114300502", n:"é„­çš“è»’", e:"Suppakarn"}
        ];

        let seatMap = new Array(56).fill(null);
        let rollCallStatus = new Array(56).fill('present');
        let archives = {};
        let isRollCallMode = false;
        let activePopoverIdx = null;

        // --- è¶…ç›´è¦ºç¸®æ”¾å¼•æ“ ---
        let scale = 0.5, left = 0, topPos = 0;
        const canvas = document.getElementById('canvasArea');
        const layer = document.getElementById('zoomLayer');

        function updateView() {
            layer.style.transform = `translate(${left}px, ${topPos}px) scale(${scale})`;
        }

        // åˆå§‹ç½®ä¸­
        window.onload = () => {
            const saved = localStorage.getItem('e1c_pro_v1');
            if (saved) { archives = JSON.parse(saved).archives || {}; renderArchives(); }
            initGrid();
            resetView();
        };

        function resetView() {
            scale = canvas.clientWidth / 1100; // è‡ªå‹•é©æ‡‰å¯¬åº¦
            left = 20; topPos = 20;
            updateView();
        }

        function zoomIn() { scale += 0.1; updateView(); }
        function zoomOut() { scale = Math.max(0.2, scale - 0.1); updateView(); }

        // æ‹–æ‹½èˆ‡ç¸®æ”¾æ‰‹å‹¢æ•´åˆ
        let isPanning = false;
        let startX, startY;

        canvas.addEventListener('mousedown', startPan);
        window.addEventListener('mousemove', pan);
        window.addEventListener('mouseup', endPan);

        canvas.addEventListener('touchstart', e => {
            if (e.touches.length === 1) startPan(e.touches[0]);
            else if (e.touches.length === 2) startPinch(e);
        }, {passive: false});

        window.addEventListener('touchmove', e => {
            if (e.touches.length === 1) pan(e.touches[0]);
            else if (e.touches.length === 2) pinch(e);
        }, {passive: false});

        window.addEventListener('touchend', endPan);

        function startPan(e) {
            if (e.target.closest('.pop-btn')) return;
            isPanning = true;
            startX = e.clientX - left;
            startY = e.clientY - topPos;
        }

        function pan(e) {
            if (!isPanning) return;
            left = e.clientX - startX;
            topPos = e.clientY - startY;
            updateView();
        }

        function endPan() { isPanning = false; }

        let initialDist = 0;
        function startPinch(e) {
            initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        }
        function pinch(e) {
            e.preventDefault();
            const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            const delta = (dist - initialDist) / 200;
            scale = Math.min(Math.max(0.15, scale + delta), 2);
            initialDist = dist;
            updateView();
        }

        // æ»¾è¼ªç¸®æ”¾
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.05 : 0.05;
            scale = Math.min(Math.max(0.15, scale + delta), 2);
            updateView();
        }, {passive: false});

        // --- åŠŸèƒ½é‚è¼¯ ---
        function initGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            let total = 0, absent = 0;
            
            seatMap.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'seat' + (s && isRollCallMode ? ' ' + rollCallStatus[i] : '');
                
                let html = `<div style="position:absolute;top:2px;left:3px;font-size:9px;color:#bbb">${(i%8)+1}-${7-Math.floor(i/8)}</div>`;
                if (s) {
                    total++;
                    html += `<div class="std-id">${s.id}</div><div class="name">${s.n}</div><div class="en-name">${s.e}</div>`;
                    if (isRollCallMode && rollCallStatus[i] !== 'present') {
                        html += `<div style="background:${rollCallStatus[i]==='absent'?'var(--danger)':'var(--warning)'};color:white;font-size:10px;padding:1px 5px;border-radius:4px;margin-top:2px">${rollCallStatus[i]==='absent'?'ç¼ºå¸­':'é²åˆ°'}</div>`;
                        if(rollCallStatus[i]==='absent') absent++;
                    }
                } else {
                    html += `<div style="font-size:24px;color:#eee">+</div>`;
                }

                if (isRollCallMode && activePopoverIdx === i) {
                    html += `<div class="rollcall-popover" onclick="event.stopPropagation()">
                        <button class="pop-btn" style="background:#eee" onclick="setRollStatus(${i},'present')">å‡ºå¸­</button>
                        <button class="pop-btn" style="background:var(--danger);color:white" onclick="setRollStatus(${i},'absent')">ç¼ºå¸­</button>
                        <button class="pop-btn" style="background:var(--warning)" onclick="setRollStatus(${i},'late')">é²åˆ°</button>
                    </div>`;
                }

                div.innerHTML = html;
                div.onclick = (e) => {
                    // å¦‚æœæ­£åœ¨æ‹–å‹•ï¼Œå‰‡ä¸è§¸ç™¼é»æ“Š
                    if (Math.abs(left - (e.clientX - startX)) > 5) return;
                    e.stopPropagation(); handleSeatClick(i);
                };
                grid.appendChild(div);
            });
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-absent').innerText = absent;
        }

        function handleSeatClick(idx) {
            if (isRollCallMode) {
                if (!seatMap[idx]) return;
                activePopoverIdx = (activePopoverIdx === idx) ? null : idx;
                initGrid();
            } else {
                const q = prompt("è¼¸å…¥å§“åæˆ–å­¸è™Ÿæœ«3ç¢¼ï¼š");
                if (q === null) return;
                if (q === "") { seatMap[idx] = null; }
                else {
                    const s = allStudents.find(x => x.n.includes(q) || x.id.endsWith(q));
                    if (s) seatMap[idx] = s;
                }
                initGrid();
            }
        }

        function setRollStatus(i, s) { rollCallStatus[i] = s; activePopoverIdx = null; initGrid(); }
        function closeAllPopovers() { if(activePopoverIdx!==null){activePopoverIdx=null; initGrid();} }
        
        function toggleMode() {
            isRollCallMode = !isRollCallMode;
            document.getElementById('mode-display').innerText = isRollCallMode ? "é»åæ¨¡å¼" : "æ’åº§æ¨¡å¼";
            document.getElementById('mode-display').style.background = isRollCallMode ? "var(--danger)" : "var(--primary)";
            initGrid();
        }

        function fillRandom() {
            let pool = allStudents.filter(s => !seatMap.includes(s)).sort(()=>Math.random()-0.5);
            let pIdx = 0;
            seatMap = seatMap.map(s => s || (pIdx < pool.length ? pool[pIdx++] : null));
            initGrid();
        }

        function createNewArchive() {
            const n = prompt("åç¨±ï¼š", `å­˜æª”_${new Date().toLocaleDateString()}`);
            if(!n) return;
            archives[n] = { seatMap: [...seatMap], rollCallStatus: [...rollCallStatus] };
            localStorage.setItem('e1c_pro_v1', JSON.stringify({ archives }));
            renderArchives();
        }

        function renderArchives() {
            document.getElementById('archive-list').innerHTML = Object.keys(archives).map(n => `
                <div class="archive-item" onclick="loadArchive('${n}')"><span>${n}</span></div>
            `).join('');
        }

        function loadArchive(n) {
            seatMap = [...archives[n].seatMap];
            rollCallStatus = archives[n].rollCallStatus || new Array(56).fill('present');
            initGrid();
            document.querySelector('.archive-panel').classList.add('collapsed');
        }
    </script>
</body>
</html>
