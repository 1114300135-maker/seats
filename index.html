<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E1C åº§ä½ç®¡ç†èˆ‡å¿«é€Ÿé»åç³»çµ±</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --bg: #f4f7f6;
        }

        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        
        .main-layout { display: flex; gap: 20px; max-width: 1400px; width: 100%; align-items: flex-start; }
        
        /* å´æ¬„å­˜æª” */
        .archive-panel { width: 220px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: sticky; top: 20px; }
        .archive-title { font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 5px; color: var(--primary); }
        .archive-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; }
        .archive-item:hover { background: #f0f7ff; }
        .del-btn { color: var(--danger); font-weight: bold; padding: 0 5px; }

        /* å³å´ä¸»å€åŸŸ */
        .content-area { flex-grow: 1; display: flex; flex-direction: column; align-items: center; position: relative; }
        .header-info { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .mode-badge { padding: 5px 15px; border-radius: 20px; font-weight: bold; color: white; font-size: 14px; transition: 0.3s; }
        .mode-setup { background: var(--primary); }
        .mode-rollcall { background: var(--danger); box-shadow: 0 0 10px rgba(231, 76, 60, 0.3); }

        .toolbar { margin-bottom: 20px; background: white; padding: 12px 25px; border-radius: 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; gap: 10px; align-items: center; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 20px; font-weight: bold; transition: 0.3s; font-size: 14px; }
        .btn-random { background: var(--success); color: white; }
        .btn-save { background: var(--accent); color: white; }
        .btn-mode { background: #6c5ce7; color: white; }

        .stats-bar { display: flex; gap: 15px; margin-bottom: 15px; background: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-item { font-size: 14px; font-weight: bold; }

        /* æ•™å®¤åœ–å½¢ */
        .classroom-container { background: #fff; padding: 50px 40px 30px 40px; border: 3px solid #333; position: relative; min-width: 920px; }
        .classroom { display: grid; grid-template-columns: repeat(8, 110px); gap: 8px; }
        .seat { border: 1px solid #ddd; height: 95px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff; cursor: pointer; position: relative; border-radius: 4px; z-index: 1; }
        .seat.manual { border: 2px solid var(--accent); }
        .seat:hover { border-color: var(--accent); }
        
        /* é»åé¡è‰²æ¨£å¼ */
        .seat.absent { background: #ffebee !important; border-color: var(--danger) !important; color: var(--danger); }
        .seat.late { background: #fff9e6 !important; border-color: var(--warning) !important; color: #b08d00; }
        .status-label { font-size: 10px; font-weight: bold; margin-top: 2px; padding: 2px 6px; border-radius: 10px; }
        .absent .status-label { background: var(--danger); color: white; }
        .late .status-label { background: var(--warning); color: black; }

        /* å½ˆå‡ºé¸å–® (Pop-over) */
        .rollcall-popover {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; border: 1px solid #ccc; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column;
            gap: 5px; padding: 8px; z-index: 100; min-width: 80px;
        }
        .pop-btn { padding: 6px 12px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .pop-present { background: #eee; color: #333; }
        .pop-absent { background: var(--danger); color: white; }
        .pop-late { background: var(--warning); color: black; }

        .seat-num { position: absolute; top: 2px; left: 2px; font-size: 10px; color: #bbb; }
        .name { font-weight: bold; font-size: 16px; }
        .plus { font-size: 24px; color: #eee; }
        .bottom-area { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; width: 100%; }
        .blackboard { flex-grow: 1; text-align: center; font-size: 22px; font-weight: bold; letter-spacing: 15px; border-top: 4px solid #333; padding-top: 10px; margin: 0 50px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body onclick="closeAllPopovers(event)">

    <div class="header-info">
        <h2 id="current-title" style="margin:0;">ğŸ« E1C åº§ä½ç®¡ç†ç³»çµ±</h2>
        <div id="mode-display" class="mode-badge mode-setup">æ’åº§æ¨¡å¼</div>
    </div>

    <div class="main-layout">
        <div class="archive-panel">
            <div class="archive-title">ğŸ“ æ­·å²å­˜æª”</div>
            <div id="archive-list"></div>
        </div>

        <div class="content-area">
            <div class="toolbar">
                <div id="setup-btns">
                    <button class="btn-random" onclick="fillRandom()">ğŸ² éš¨æ©Ÿæ’åˆ—</button>
                    <button class="btn-save" onclick="createNewArchive()">ğŸ’¾ ä¿å­˜ç›®å‰ç‰ˆæœ¬</button>
                    <button class="btn-reset" onclick="resetAll()" style="background:#95a5a6; color:white;">ğŸ§¹ é‡ç½®</button>
                </div>
                <button class="btn-mode" onclick="toggleMode()">ğŸ”„ åˆ‡æ›ç‚ºé»åæ¨¡å¼</button>
                <button style="background:#333; color:white" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
            </div>

            <div id="rollcall-stats" class="stats-bar hidden">
                <div class="stat-item">æ‡‰åˆ°: <span id="stat-total">0</span></div>
                <div class="stat-item" style="color:var(--success)">å¯¦åˆ°: <span id="stat-present">0</span></div>
                <div class="stat-item" style="color:var(--danger)">ç¼ºå¸­: <span id="stat-absent">0</span></div>
                <div class="stat-item" style="color:var(--warning)">é²åˆ°: <span id="stat-late">0</span></div>
            </div>

            <div class="classroom-container">
                <div class="classroom" id="grid"></div>
                <div class="bottom-area">
                    <div class="blackboard">BLACKBOARD</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const allStudents = [
            {id:"1114300121", n:"é¾”æ˜±ç‘„", e:"Kelly"}, {id:"1114300122", n:"ä½™æ²›å®¹", e:"Melody"}, {id:"1114300123", n:"é™³æ¹˜ç”¯", e:"Ariel"}, {id:"1114300124", n:"æ—æ²æ¦†", e:"Amber"}, {id:"1114300125", n:"è•­ç¾½å½¤", e:"Amelia"}, {id:"1114300126", n:"æ—å¥•å¸†", e:"Ivan"}, {id:"1114300127", n:"é™³ä¹™ç‘„", e:"Sharon"}, {id:"1114300128", n:"ç‹æ¼†å¦¤", e:"Zoie"}, {id:"1114300129", n:"é™³éœå®œ", e:"Luna"}, {id:"1114300130", n:"é™³ç¥‰æ©", e:"Bianca"}, {id:"1114300131", n:"é™³åˆç‘„", e:"Christy"}, {id:"1114300132", n:"è³´å®¥ç’‡", e:"Alina"}, {id:"1114300133", n:"é™³çŸæ…ˆ", e:"Emily"}, {id:"1114300134", n:"æ±ŸèŠ¯èª", e:"Ina"}, {id:"1114300135", n:"é™³ä¸–è±ª", e:"Howard"}, {id:"1114300136", n:"æ›¾å®‰å²‘", e:"Ann"}, {id:"1114300137", n:"è³´ç‘¾å®‰", e:"Ashley"}, {id:"1114300138", n:"ç¾…å‡±çˆ¾", e:"Mikayeel"}, {id:"1114300139", n:"è¾›ä¿Šæ–‡", e:"Jun-wen"}, {id:"1114300140", n:"é»ƒé–æ™", e:"Amber"}, {id:"1114300141", n:"æ—ç´«é¨", e:"Nancy"}, {id:"1114300142", n:"å³éœˆç‘œ", e:"Yuri"}, {id:"1114300143", n:"è¨±å”¯èŠ¯", e:"Una"}, {id:"1114300144", n:"éŠèŠ¯èª", e:"Abby"}, {id:"1114300145", n:"éŠæ¢å¥é›…", e:"Luna"}, {id:"1114300146", n:"æå©•ç¦•", e:"Eve"}, {id:"1114300147", n:"ææ©å¦®", e:"Miu Miu"}, {id:"1114300148", n:"æ—é‡‘å§µ", e:"Linda"}, {id:"1114300149", n:"é™³å¯ç´œ", e:"Amber"}, {id:"1114300151", n:"å¼µé›…çŸ", e:"Judy"}, {id:"1114300152", n:"ç‰›æ˜±ç¿”", e:"Sean"}, {id:"1114300153", n:"é™³ä»¥å©•", e:"Emma"}, {id:"1114300154", n:"å¼µéˆºå©•", e:"Wendy"}, {id:"1114300155", n:"æœ±é›¯èŠ³", e:"Mia"}, {id:"1114300156", n:"é€£å­ç”¯", e:"Liliya"}, {id:"1114300157", n:"æ¥ŠèŠ·èŠ¹", e:"Alex"}, {id:"1114300158", n:"é™³ç¦æ¶µ", e:"Hannah"}, {id:"1114300159", n:"é™³å† å®‡", e:"Benson"}, {id:"1114300160", n:"é™³æ¼¢åº­", e:"Lina"}, {id:"1114300161", n:"å¼µä¹™èŠ¹", e:"Irene"}, {id:"1114300162", n:"ç‹å¦è»", e:"Grace"}, {id:"1114300163", n:"æ›²å­å¯¬", e:"Miller"}, {id:"1114300164", n:"ç‹ä»¥å€«", e:"Juan Jose"}, {id:"1114300165", n:"è¶™äºå«»", e:"Abby"}, {id:"1114300166", n:"æ—å®œæ¨º", e:"Novalie"}, {id:"1114300167", n:"æŸ¯å“ç‘€", e:"Pamela"}, {id:"1114300168", n:"å“å½¥å‡", e:"Cynthia"}, {id:"1114300169", n:"ææ˜“æ˜Œ", e:"Jason"}, {id:"1114300170", n:"å¼µå­ç‘œ", e:"Yvonne"}, {id:"1114300171", n:"å¼µæ¹˜ç¿Š", e:"Cecelia"}, {id:"1114300172", n:"å»–éšè–‡", e:"Nicole"}, {id:"1114300173", n:"é»ƒæ¯“éœ", e:"Lily"}, {id:"1114300174", n:"è”¡æ‚…ç³", e:"Lina"}, {id:"1114300175", n:"é™³å®¥å‰", e:"Iris"}, {id:"1114300501", n:"è³ˆä¼¯ç", e:"Haein"}, {id:"1114300502", n:"é„­çš“è»’", e:"Suppakarn"}
        ];

        let seatMap = new Array(56).fill(null);
        let manualSeats = new Set();
        let rollCallStatus = new Array(56).fill('present');
        let archives = {};
        let isRollCallMode = false;
        let activePopoverIdx = null;

        window.onload = () => {
            const saved = localStorage.getItem('e1c_v4_data');
            if (saved) { archives = JSON.parse(saved).archives || {}; updateArchiveList(); }
            initGrid();
        };

        function toggleMode() {
            isRollCallMode = !isRollCallMode;
            activePopoverIdx = null;
            document.getElementById('mode-display').innerText = isRollCallMode ? "é»åæ¨¡å¼" : "æ’åº§æ¨¡å¼";
            document.getElementById('mode-display').className = "mode-badge " + (isRollCallMode ? "mode-rollcall" : "mode-setup");
            document.getElementById('setup-btns').classList.toggle('hidden', isRollCallMode);
            document.getElementById('rollcall-stats').classList.toggle('hidden', !isRollCallMode);
            document.querySelector('.btn-mode').innerText = isRollCallMode ? "ğŸ”„ åˆ‡æ›ç‚ºæ’åº§æ¨¡å¼" : "ğŸ”„ åˆ‡æ›ç‚ºé»åæ¨¡å¼";
            initGrid();
        }

        function initGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            let total = 0, absent = 0, late = 0;

            for (let i = 0; i < 56; i++) {
                const student = seatMap[i];
                const seatDiv = document.createElement('div');
                let classList = ['seat'];
                
                if (student) {
                    total++;
                    if (isRollCallMode) {
                        if (rollCallStatus[i] === 'absent') { classList.push('absent'); absent++; }
                        if (rollCallStatus[i] === 'late') { classList.push('late'); late++; }
                    } else if (manualSeats.has(i)) {
                        classList.push('manual');
                    }
                }
                
                seatDiv.className = classList.join(' ');
                seatDiv.onclick = (e) => { e.stopPropagation(); handleSeatClick(i); };
                
                let content = `<div class="seat-num">${(i%8)+1}-${7-Math.floor(i/8)}</div>`;
                if (student) {
                    content += `<div class="name">${student.n}</div>`;
                    if (isRollCallMode && rollCallStatus[i] !== 'present') {
                        content += `<div class="status-label">${rollCallStatus[i] === 'absent' ? 'ç¼ºå¸­' : 'é²åˆ°'}</div>`;
                    }
                } else {
                    content += `<div class="plus">+</div>`;
                }

                // å¦‚æœæ˜¯é»åæ¨¡å¼ä¸”é¸å–®é–‹å•Ÿä¸­
                if (isRollCallMode && activePopoverIdx === i) {
                    content += `
                    <div class="rollcall-popover" onclick="event.stopPropagation()">
                        <button class="pop-btn pop-present" onclick="setRollStatus(${i}, 'present')">å‡ºå¸­</button>
                        <button class="pop-btn pop-absent" onclick="setRollStatus(${i}, 'absent')">ç¼ºå¸­</button>
                        <button class="pop-btn pop-late" onclick="setRollStatus(${i}, 'late')">é²åˆ°</button>
                    </div>`;
                }

                seatDiv.innerHTML = content;
                grid.appendChild(seatDiv);
            }

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-absent').innerText = absent;
            document.getElementById('stat-late').innerText = late;
            document.getElementById('stat-present').innerText = total - absent;
        }

        function handleSeatClick(index) {
            if (isRollCallMode) {
                if (!seatMap[index]) return;
                activePopoverIdx = (activePopoverIdx === index) ? null : index;
                initGrid();
            } else {
                const query = prompt("è¼¸å…¥å§“åæˆ–å­¸è™Ÿæœ«3ç¢¼ï¼š");
                if (query === null) return;
                if (query === "") {
                    seatMap[index] = null; manualSeats.delete(index);
                } else {
                    const student = allStudents.find(s => s.n.includes(query) || s.id.endsWith(query));
                    if (!student) return alert("æ‰¾ä¸åˆ°äºº");
                    const oldIdx = seatMap.findIndex(s => s && s.id === student.id);
                    if (oldIdx !== -1) seatMap[oldIdx] = null;
                    seatMap[index] = student; manualSeats.add(index);
                }
                initGrid();
            }
        }

        function setRollStatus(index, status) {
            rollCallStatus[index] = status;
            activePopoverIdx = null; // é¸å®Œé—œé–‰
            initGrid();
        }

        function closeAllPopovers() {
            if (activePopoverIdx !== null) {
                activePopoverIdx = null;
                initGrid();
            }
        }

        function fillRandom() {
            const occupiedIds = seatMap.filter(s => s !== null).map(s => s.id);
            let pool = allStudents.filter(s => !occupiedIds.includes(s.id)).sort(() => Math.random() - 0.5);
            let poolIdx = 0;
            for (let i = 0; i < 56; i++) {
                if (seatMap[i] === null && poolIdx < pool.length) seatMap[i] = pool[poolIdx++];
            }
            initGrid();
        }

        function createNewArchive() {
            const name = prompt("å­˜æª”åç¨±ï¼š", `åº§ä½è¡¨_${new Date().toLocaleDateString()}`);
            if (!name) return;
            archives[name] = { seatMap: [...seatMap], manualSeats: Array.from(manualSeats), rollCallStatus: [...rollCallStatus] };
            saveToStorage(); updateArchiveList();
        }

        function loadArchive(name) {
            const data = archives[name];
            seatMap = [...data.seatMap]; manualSeats = new Set(data.manualSeats);
            rollCallStatus = data.rollCallStatus || new Array(56).fill('present');
            document.getElementById('current-title').innerText = name; initGrid();
        }

        function deleteArchive(name, e) {
            e.stopPropagation(); if (confirm("åˆªé™¤ï¼Ÿ")) { delete archives[name]; saveToStorage(); updateArchiveList(); }
        }

        function saveToStorage() { localStorage.setItem('e1c_v4_data', JSON.stringify({ archives })); }
        
        function updateArchiveList() {
            document.getElementById('archive-list').innerHTML = Object.keys(archives).map(name => `
                <div class="archive-item" onclick="loadArchive('${name}')">
                    <span>${name}</span><span class="del-btn" onclick="deleteArchive('${name}', event)">Ã—</span>
                </div>`).join('');
        }

        function resetAll() {
            if (confirm("æ¸…ç©ºï¼Ÿ")) { seatMap.fill(null); manualSeats.clear(); rollCallStatus.fill('present'); initGrid(); }
        }
    </script>
</body>
</html>
