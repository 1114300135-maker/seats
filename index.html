<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E1C Â∫ß‰ΩçÈªûÂêçÁ≥ªÁµ± (Â∞àÊ•≠Áµ≤ÊªëÁâà)</title>
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60;
            --danger: #e74c3c; --warning: #f1c40f; --bg: #f4f7f6;
        }

        body { 
            font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); 
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        
        .top-nav { background: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; }
        .main-container { flex: 1; display: flex; position: relative; overflow: hidden; }

        .archive-panel { 
            width: 220px; background: #fff; border-right: 1px solid #ddd; 
            padding: 15px; overflow-y: auto; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute; left: 0; top: 0; bottom: 0; z-index: 999;
        }
        .archive-panel.collapsed { transform: translateX(-100%); }

        .canvas-area { flex: 1; position: relative; background: #d1d8e0; overflow: hidden; touch-action: none; }
        
        /* Á∏ÆÊîæÂ±§ÔºöÂàùÂßãË®≠ÂÆö transition ‰ª•‰æøÈáçÁΩÆÊôÇÂπ≥Êªë */
        #zoomLayer { 
            position: absolute; transform-origin: 0 0; will-change: transform;
            transition: transform 0.1s ease-out; 
            padding: 200px;
        }

        .classroom-container { 
            background: #fff; padding: 60px 50px; border: 5px solid #222; 
            min-width: 950px; border-radius: 4px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }
        .classroom { display: grid; grid-template-columns: repeat(8, 115px); gap: 12px; }
        .seat { 
            border: 1px solid #ddd; height: 105px; background: #fff; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            position: relative; border-radius: 8px; transition: background 0.2s, border 0.2s;
        }
        .seat.absent { background: #fee2e2 !important; border-color: var(--danger) !important; }
        .seat.late { background: #fef3c7 !important; border-color: var(--warning) !important; }

        .ui-btn { padding: 6px 15px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 13px; }
        .zoom-controls { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .circle-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        .rollcall-popover {
            position: absolute; inset: 0; background: rgba(255,255,255,0.96);
            display: flex; flex-direction: column; padding: 5px; gap: 4px; z-index: 10; border-radius: 8px;
        }
        .pop-btn { flex: 1; border: 1px solid #e2e8f0; border-radius: 5px; font-weight: bold; font-size: 12px; background: #fff; }

        .name { font-weight: 800; font-size: 17px; color: #1a202c; }
        .std-id { font-size: 10px; color: #718096; margin-bottom: 2px; }
        .en-name { font-size: 11px; color: #4a5568; }
        
        .stats-badge { position: absolute; bottom: 20px; left: 20px; background: rgba(30,41,59,0.9); color: white; padding: 10px 18px; border-radius: 30px; font-size: 13px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body onclick="closeAllPopovers(event)">

    <div class="top-nav">
        <div style="display:flex; align-items:center; gap:12px;">
            <button onclick="toggleArchive()" class="ui-btn" style="background:#475569; padding:8px;">‚ò∞</button>
            <span id="current-title" style="font-weight:900; letter-spacing:1px;">E1C SEATING</span>
            <div id="mode-display" style="font-size:11px; padding:4px 12px; border-radius:12px; background:var(--primary); color:white; font-weight:bold;">SETUP MODE</div>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="ui-btn" style="background:var(--success);" onclick="fillRandom()">üé≤ Èö®Ê©ü</button>
            <button class="ui-btn" style="background:var(--accent);" onclick="createNewArchive()">üíæ Â≠òÊ™î</button>
            <button class="ui-btn" style="background:#6366f1;" onclick="toggleMode()">üîÑ Ê®°ÂºèÂàáÊèõ</button>
        </div>
    </div>

    <div class="main-container">
        <div class="archive-panel collapsed" id="archivePanel">
            <h4 style="margin:0 0 15px 0; color:var(--primary); border-bottom:2px solid #eee; padding-bottom:5px;">üìÅ Ê≠∑Âè≤Â≠òÊ™î</h4>
            <div id="archive-list"></div>
        </div>

        <div class="canvas-area" id="viewport">
            <div id="zoomLayer">
                <div class="classroom-container">
                    <div class="classroom" id="grid"></div>
                    <div style="margin-top:40px; border-top:4px solid #333; text-align:center; font-weight:900; letter-spacing:20px; font-size:24px; padding-top:15px; color:#333;">BLACKBOARD</div>
                </div>
            </div>
        </div>

        <div class="stats-badge">
            ÊáâÂà∞: <span id="stat-total">0</span> | Áº∫Â∏≠: <span id="stat-absent" style="color:#fb7185; font-weight:bold;">0</span>
        </div>

        <div class="zoom-controls">
            <button class="ui-btn circle-btn" onclick="manualZoom(0.15)">+</button>
            <button class="ui-btn circle-btn" onclick="manualZoom(-0.15)">-</button>
            <button class="ui-btn" style="background:#64748b; margin-top:5px;" onclick="resetView()">RESET</button>
        </div>
    </div>

    <script>
        const allStudents = [
            {id:"1114300121", n:"ÈæîÊò±ÁëÑ", e:"Kelly"}, {id:"1114300122", n:"‰ΩôÊ≤õÂÆπ", e:"Melody"}, {id:"1114300123", n:"Èô≥ÊπòÁîØ", e:"Ariel"}, {id:"1114300124", n:"ÊûóÊ≤ÅÊ¶Ü", e:"Amber"}, {id:"1114300125", n:"Ëï≠ÁæΩÂΩ§", e:"Amelia"}, {id:"1114300126", n:"ÊûóÂ•ïÂ∏Ü", e:"Ivan"}, {id:"1114300127", n:"Èô≥‰πôÁëÑ", e:"Sharon"}, {id:"1114300128", n:"ÁéãÊºÜÂ¶§", e:"Zoie"}, {id:"1114300129", n:"Èô≥ÈùúÂÆú", e:"Luna"}, {id:"1114300130", n:"Èô≥Á•âÊÅ©", e:"Bianca"}, {id:"1114300131", n:"Èô≥ÂèàÁëÑ", e:"Christy"}, {id:"1114300132", n:"Ë≥¥ÂÆ•Áíá", e:"Alina"}, {id:"1114300133", n:"Èô≥ÁéüÊÖà", e:"Emily"}, {id:"1114300134", n:"Ê±üËäØË™û", e:"Ina"}, {id:"1114300135", n:"Èô≥‰∏ñË±™", e:"Howard"}, {id:"1114300136", n:"ÊõæÂÆâÂ≤ë", e:"Ann"}, {id:"1114300137", n:"Ë≥¥ÁëæÂÆâ", e:"Ashley"}, {id:"1114300138", n:"ÁæÖÂá±Áàæ", e:"Mikayeel"}, {id:"1114300139", n:"Ëæõ‰øäÊñá", e:"Jun-wen"}, {id:"1114300140", n:"ÈªÉÈùñÊôè", e:"Amber"}, {id:"1114300141", n:"ÊûóÁ¥´È®è", e:"Nancy"}, {id:"1114300142", n:"Âê≥ÈúàÁëú", e:"Yuri"}, {id:"1114300143", n:"Ë®±ÂîØËäØ", e:"Una"}, {id:"1114300144", n:"ÈÅäËäØË™û", e:"Abby"}, {id:"1114300145", n:"ÈÅäÊ¢ÅÂÅ•ÈõÖ", e:"Luna"}, {id:"1114300146", n:"ÊùéÂ©ïÁ¶ï", e:"Eve"}, {id:"1114300147", n:"ÊùéÊÅ©Â¶Æ", e:"Miu Miu"}, {id:"1114300148", n:"ÊûóÈáëÂßµ", e:"Linda"}, {id:"1114300149", n:"Èô≥ÂèØÁ¥ú", e:"Amber"}, {id:"1114300151", n:"ÂºµÈõÖÁéü", e:"Judy"}, {id:"1114300152", n:"ÁâõÊò±Áøî", e:"Sean"}, {id:"1114300153", n:"Èô≥‰ª•Â©ï", e:"Emma"}, {id:"1114300154", n:"ÂºµÈà∫Â©ï", e:"Wendy"}, {id:"1114300155", n:"Êú±ÈõØËä≥", e:"Mia"}, {id:"1114300156", n:"ÈÄ£Â≠êÁîØ", e:"Liliya"}, {id:"1114300157", n:"Ê•äËä∑Ëäπ", e:"Alex"}, {id:"1114300158", n:"Èô≥Áê¶Ê∂µ", e:"Hannah"}, {id:"1114300159", n:"Èô≥ÂÜ†ÂÆá", e:"Benson"}, {id:"1114300160", n:"Èô≥Êº¢Â∫≠", e:"Lina"}, {id:"1114300161", n:"Âºµ‰πôËäπ", e:"Irene"}, {id:"1114300162", n:"ÁéãÂ¶çËèª", e:"Grace"}, {id:"1114300163", n:"Êõ≤Â≠ùÂØ¨", e:"Miller"}, {id:"1114300164", n:"Áéã‰ª•ÂÄ´", e:"Juan Jose"}, {id:"1114300165", n:"Ë∂ô‰∫éÂ´ª", e:"Abby"}, {id:"1114300166", n:"ÊûóÂÆúÊ®∫", e:"Novalie"}, {id:"1114300167", n:"ÊüØÂìÅÁëÄ", e:"Pamela"}, {id:"1114300168", n:"ÂçìÂΩ•Âùá", e:"Cynthia"}, {id:"1114300169", n:"ÊùéÊòìÊòå", e:"Jason"}, {id:"1114300170", n:"ÂºµÂ≠êÁëú", e:"Yvonne"}, {id:"1114300171", n:"ÂºµÊπòÁøä", e:"Cecelia"}, {id:"1114300172", n:"ÂªñÈùöËñá", e:"Nicole"}, {id:"1114300173", n:"ÈªÉÊØìÈúè", e:"Lily"}, {id:"1114300174", n:"Ëî°ÊÇÖÁê≥", e:"Lina"}, {id:"1114300175", n:"Èô≥ÂÆ•Âçâ", e:"Iris"}, {id:"1114300501", n:"Ë≥à‰ºØÁèç", e:"Haein"}, {id:"1114300502", n:"ÈÑ≠ÁöìËªí", e:"Suppakarn"}
        ];

        let seatMap = new Array(56).fill(null);
        let rollCallStatus = new Array(56).fill('present');
        let archives = {};
        let isRollCallMode = false;
        let activePopoverIdx = null;

        // --- Ê†∏ÂøÉÁ∏ÆÊîæÂºïÊìé (Â∞àÊ•≠Áâà) ---
        let scale = 0.5, posX = 0, posY = 0;
        const viewport = document.getElementById('viewport');
        const content = document.getElementById('zoomLayer');

        function updateTransform() {
            requestAnimationFrame(() => {
                content.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
            });
        }

        // Á∏ÆÊîæ‰∏≠ÂøÉË£úÂÑüÂÖ¨ÂºèÊáâÁî®
        function adjustZoom(delta, centerX, centerY) {
            const rect = viewport.getBoundingClientRect();
            const cx = centerX - rect.left;
            const cy = centerY - rect.top;

            const prevScale = scale;
            scale = Math.min(Math.max(0.15, scale + delta), 2.5);

            // Ê†∏ÂøÉË£úÂÑüÈÇèËºØÔºöÁ¢∫‰øù‰∏≠ÂøÉÈªû‰∏çÂãï
            posX = cx - (cx - posX) * (scale / prevScale);
            posY = cy - (cy - posY) * (scale / prevScale);
            
            updateTransform();
        }

        // ÊªæËº™‰∫ã‰ª∂
        viewport.addEventListener('wheel', e => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.08 : 0.08;
            adjustZoom(delta, e.clientX, e.clientY);
        }, {passive: false});

        // ÊãñÊãΩ‰∫ã‰ª∂ (ÁÆ°ÁêÜ Transition ‰ª•ÈÅøÂÖçÂª∂ÈÅ≤)
        let isPanning = false, startX, startY;

        function handleStart(e) {
            if (e.target.closest('.pop-btn') || e.target.closest('.ui-btn')) return;
            isPanning = true;
            content.style.transition = "none"; // ÊãñÂãïÊôÇÈóúÈñâÂãïÁï´ÔºåÊ∂àÈô§ÊäñÂãï
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            startX = clientX - posX;
            startY = clientY - posY;
        }

        function handleMove(e) {
            if (!isPanning) return;
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            posX = clientX - startX;
            posY = clientY - startY;
            updateTransform();
        }

        function handleEnd() {
            isPanning = false;
            content.style.transition = "transform 0.1s ease-out"; // ÊîæÈñãÂæåÊÅ¢Âæ©ÂãïÁï´
        }

        viewport.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);

        // ÊâãÊ©üËß∏ÊéßÊîØÊè¥
        let initialPinchDist = 0;
        viewport.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                initialPinchDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            } else {
                handleStart(e);
            }
        }, {passive: false});

        viewport.addEventListener('touchmove', e => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                const delta = (dist - initialPinchDist) / 400;
                adjustZoom(delta, midX, midY);
                initialPinchDist = dist;
            } else {
                handleMove(e);
            }
        }, {passive: false});

        viewport.addEventListener('touchend', handleEnd);

        function manualZoom(delta) {
            adjustZoom(delta, window.innerWidth/2, window.innerHeight/2);
        }

        function resetView() {
            scale = viewport.clientWidth / 1200;
            posX = 20; posY = 20;
            updateTransform();
        }

        // --- Ê•≠ÂãôÈÇèËºØ ---
        function initGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            let total = 0, abs = 0;
            seatMap.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'seat' + (s && isRollCallMode ? ' ' + rollCallStatus[i] : '');
                let html = `<div style="position:absolute;top:2px;left:4px;font-size:9px;color:#cbd5e0">${(i%8)+1}-${7-Math.floor(i/8)}</div>`;
                if (s) {
                    total++;
                    html += `<div class="std-id">${s.id}</div><div class="name">${s.n}</div><div class="en-name">${s.e}</div>`;
                    if (isRollCallMode && rollCallStatus[i] !== 'present') {
                        const label = rollCallStatus[i] === 'absent' ? 'Áº∫Â∏≠' : 'ÈÅ≤Âà∞';
                        html += `<div style="background:${rollCallStatus[i]==='absent'?'var(--danger)':'var(--warning)'};color:white;font-size:10px;padding:2px 6px;border-radius:4px;margin-top:4px;font-weight:bold">${label}</div>`;
                        if(rollCallStatus[i]==='absent') abs++;
                    }
                } else html += `<div style="font-size:24px;color:#f1f5f9">+</div>`;

                if (isRollCallMode && activePopoverIdx === i) {
                    html += `<div class="rollcall-popover" onclick="event.stopPropagation()">
                        <button class="pop-btn" onclick="setRollStatus(${i},'present')">Âá∫Â∏≠</button>
                        <button class="pop-btn" style="background:var(--danger);color:white" onclick="setRollStatus(${i},'absent')">Áº∫Â∏≠</button>
                        <button class="pop-btn" style="background:var(--warning)" onclick="setRollStatus(${i},'late')">ÈÅ≤Âà∞</button>
                    </div>`;
                }
                div.innerHTML = html;
                div.onclick = (e) => {
                    if (isPanning) return;
                    e.stopPropagation(); handleSeatClick(i);
                };
                grid.appendChild(div);
            });
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-absent').innerText = abs;
        }

        function handleSeatClick(idx) {
            if (isRollCallMode) {
                if (!seatMap[idx]) return;
                activePopoverIdx = (activePopoverIdx === idx) ? null : idx;
                initGrid();
            } else {
                const q = prompt("Ëº∏ÂÖ•ÂßìÂêçÊàñÂ≠∏ËôüÊú´3Á¢ºÔºö");
                if (q === null) return;
                if (q === "") seatMap[idx] = null;
                else {
                    const s = allStudents.find(x => x.n.includes(q) || x.id.endsWith(q));
                    if (s) seatMap[idx] = s;
                }
                initGrid();
            }
        }

        function setRollStatus(i, s) { rollCallStatus[i] = s; activePopoverIdx = null; initGrid(); }
        function closeAllPopovers() { if(activePopoverIdx!==null){activePopoverIdx=null; initGrid();} }
        function toggleMode() {
            isRollCallMode = !isRollCallMode;
            document.getElementById('mode-display').innerText = isRollCallMode ? "ROLL CALL MODE" : "SETUP MODE";
            document.getElementById('mode-display').style.background = isRollCallMode ? "var(--danger)" : "var(--primary)";
            initGrid();
        }
        function fillRandom() {
            let pool = allStudents.filter(s => !seatMap.includes(s)).sort(()=>Math.random()-0.5);
            let pIdx = 0;
            seatMap = seatMap.map(s => s || (pIdx < pool.length ? pool[pIdx++] : null));
            initGrid();
        }
        function toggleArchive() { document.getElementById('archivePanel').classList.toggle('collapsed'); }
        function createNewArchive() {
            const n = prompt("Â≠òÊ™îÂêçÁ®±Ôºö", `Áè≠Á¥ö_${new Date().toLocaleDateString()}`);
            if(!n) return;
            archives[n] = { seatMap: [...seatMap], rollCallStatus: [...rollCallStatus] };
            localStorage.setItem('e1c_pro_v1', JSON.stringify({ archives }));
            renderArchives();
        }
        function renderArchives() {
            document.getElementById('archive-list').innerHTML = Object.keys(archives).map(n => `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; font-size:13px;" onclick="loadArchive('${n}')">${n}</div>`).join('');
        }
        function loadArchive(n) {
            seatMap = [...archives[n].seatMap];
            rollCallStatus = archives[n].rollCallStatus || new Array(56).fill('present');
            initGrid(); toggleArchive();
        }
        window.onload = () => {
            const saved = localStorage.getItem('e1c_pro_v1');
            if (saved) { archives = JSON.parse(saved).archives || {}; renderArchives(); }
            initGrid(); resetView();
        };
    </script>
</body>
</html>
